var quform=function(e,r,o,i){"use strict";var a,s=e.core,n=s.cache,t=r(document),g=!1,m=[],f=1,c=0,l=!0;return r((a={init:function(){n.get("#qfb_migrate_forms").change(function(){n.get("#qfb_migrate_forms_custom").closest(s.settingWrap)["specific"==n.get("#qfb_migrate_forms").val()?"qfbSlideShow":"qfbSlideHide"]()}),r.fn.select2&&n.get("#qfb_migrate_forms_custom").select2({theme:"qfb",language:{noResults:function(){return i.noResultsFound}}}),n.get("#qfb-migrate-start").click(a.startMigration),n.get("#qfb-migrate-stop").click(function(){l=!1,n.get("#qfb-migrate-stop-text").text(o.stopping)}),n.get("#qfb-migrate-close").click(function(){n.get("#qfb-migrate-progress").hide(),n.get("body").css("overflow",""),n.get("#qfb-migrate-progress-bar-inner").width(0),n.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-info"),n.get("#qfb-migrate-current-task-text").text(o.processing),n.get("#qfb-migrate-close").hide(),n.get("#qfb-migrate-stop-text").text(o.stopMigration),n.get("#qfb-migrate-progress").find(".qfb-submission-error").remove(),n.get("#qfb-migrate-errors").empty()}),n.get("#qfb-import-form-button").click(a["import"]),t.on("heartbeat-tick",function(e,t){t&&t.nonces_expired&&(t.quformMigrateSettingsNonce&&o.migrateSettingsNonce!==t.quformMigrateSettingsNonce&&(o.migrateSettingsNonce=t.quformMigrateSettingsNonce),t.quformMigrateNonce&&o.migrateNonce!==t.quformMigrateNonce&&(o.migrateNonce=t.quformMigrateNonce),t.quformMigrateImportFormNonce&&o.migrateImportFormNonce!==t.quformMigrateImportFormNonce&&(o.migrateImportFormNonce=t.quformMigrateImportFormNonce))})},startMigration:function(){var e;n.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),"specific"!=n.get("#qfb_migrate_forms").val()||(e=n.get("#qfb_migrate_forms_custom").val(),r.isArray(e)&&e.length)?(n.get("#qfb-migrate-progress").show(),n.get("body").css("overflow","hidden"),n.get("#qfb-migrate-progress-bar-inner").width(0),n.get("#qfb-migrate-current-task-text").text(o.processing),"specific"==n.get("#qfb_migrate_forms").val()?(e=r.map(e,function(e){return parseInt(e,10)}),a.migrateForms(e)):r.ajax({type:"POST",url:i.ajaxUrl,data:{action:"quform_migrate_get_all_form_ids"},dataType:"json"}).done(function(e){"success"==(e=s.sanitizeResponse(e)).type&&r.isArray(e.formIds)&&e.formIds.length?a.migrateForms(e.formIds):a.migrationFailed(e.message)}).fail(function(){a.migrationFailed(i.ajaxError)}),(n.get("#qfb_migrate_license").is(":checked")||n.get("#qfb_migrate_recaptcha_keys").is(":checked"))&&r.ajax({type:"POST",url:i.ajaxUrl,data:{action:"quform_migrate_settings",_ajax_nonce:o.migrateSettingsNonce,migrate_license_key:n.get("#qfb_migrate_license").is(":checked")?"1":"0",migrate_recaptcha_keys:n.get("#qfb_migrate_recaptcha_keys").is(":checked")?"1":"0"},dataType:"json"}).done(function(e){"error"==(e=s.sanitizeResponse(e)).type&&s.addValidationError(n.get("#qfb-migrate-errors"),o.errorMigratingKeys.replace("%s",e.message))}).fail(function(){s.addValidationError(n.get("#qfb-migrate-errors"),o.errorMigratingKeys.replace("%s",i.ajaxError))})):s.addValidationError(n.get("#qfb_migrate_forms_custom").closest(s.settingInputWrap),i.thisFieldIsRequired)},migrateForms:function(e){c=(m=e).length,f=1,l=!0,n.get("#qfb-migrate-stop").css("display","inline-block"),a.migrateForm(m.shift())},migrateForm:function(t){r.ajax({type:"POST",url:i.ajaxUrl,data:{action:"quform_migrate_form",_ajax_nonce:o.migrateNonce,form_id:t,migrate_entries:n.get("#qfb_migrate_entries").is(":checked")?"1":"0"},dataType:"json"}).done(function(e){a.updateStatus(t,s.sanitizeResponse(e))}).fail(function(){a.updateStatus(t,{type:"error",message:i.ajaxError})})},updateStatus:function(e,t){var r=Math.round(f/c*100);n.get("#qfb-migrate-progress-bar-inner").width(r+"%"),f++,"error"==t.type&&s.addValidationError(n.get("#qfb-migrate-errors"),o.errorMigratingForm.replace("%d",e).replace("%s",t.message)),m.length&&l?a.migrateForm(m.shift()):a.migrationCompleted()},migrationCompleted:function(){n.get("#qfb-migrate-stop").hide(),n.get("#qfb-migrate-close").css("display","inline-block"),l?(n.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-success"),n.get("#qfb-migrate-current-task-text").text(o.migrationCompleted)):n.get("#qfb-migrate-current-task-text").text(o.migrationStopped)},migrationFailed:function(e){n.get("#qfb-migrate-stop").hide(),n.get("#qfb-migrate-close").css("display","inline-block"),s.addSubmissionError(n.get("#qfb-migrate-progress-inner"),o.errorStartingMigration.replace("%s",e)),n.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-error"),n.get("#qfb-migrate-current-task-text").text(o.migrationError)},validate:function(){if(n.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),""===n.get("#qfb-import-form-data").val()){var e=n.get("#qfb-import-form-data").closest(s.settingWrap);return s.addValidationError(e,i.thisFieldIsRequired),s.scrollTo(e),!1}return!0},"import":function(){if(!g){if(!a.validate())return!1;g=!0,r.ajax({type:"POST",url:i.ajaxUrl,data:{action:"quform_migrate_import_form",_ajax_nonce:o.migrateImportFormNonce,config:n.get("#qfb-import-form-data").val()},dataType:"json"}).done(function(e){e=s.sanitizeResponse(e),n.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),g=!1,"success"==e.type?a.onImportSuccess(e.message):"error"!=e.type&&"invalid"!=e.type||a.onImportFail(e)}).fail(function(){n.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),g=!1,a.onImportFail({message:i.ajaxError})})}},onImportSuccess:function(e){s.showFixedMessage(e,"success",0)},onImportFail:function(e){var i;s.isNonEmptyString(e.message)&&s.showFixedMessage(o.errorImportingForm+"<br>"+e.message,"error"),e.errors&&r.each(e.errors,function(e,t){var r=n.get("#"+e).closest(s.settingWrap);i||(i=r),s.addValidationError(r,t)}),i&&s.scrollTo(i)}}).init),e.tools=e.tools||{},e.tools.migrate=a,e}(quform,jQuery,quformToolsMigrateL10n,quformCoreL10n);